---
title: "FunES#10: Странный массив"
date: "2019-05-24T14:34:08.000Z"
description: "Точнее все ок, магии нет Буквально недавно на Reddit [https://www.reddit.com/r/javascript/comments/brjxab/nan_can_be_used_as_an_"
---

<h4>Точнее все ок, магии нет</h4>
<p>Буквально недавно на <a href="https://www.reddit.com/r/javascript/comments/brjxab/nan_can_be_used_as_an_array_index/" target="_blank" rel="noopener noreferrer">Reddit</a> был показан интересный пример “нетипичного” поведения JS. Через некоторое время этот “мем” ушел в твиттер и его даже запостил Axel Rauschmayer‏, что придало этому примеру большой резонанс.</p>
<p>У меня была очень загруженная неделя, полностью отключилось критическое мышление и я тоже увидел в этом некоторую магию. Но спустя час коллега мне подсказал что я ошибся. Магии нет. Еще раз взглянув трезвым взглядом, я понял что и правда, магии нет и все работает штатно. Так о чем это я?</p>
<p>О том что есть у вас массив. Есть некоторый вычисляемый индекс и в какой-то момент вместо числа приходит NaN. Может такое быть? Может. И вы “создаете в массиве” элемент с индексом NaN:</p>
<pre><strong>const</strong> a = [];<br>a[<strong>NaN</strong>] = 123;</pre>
<p>И далее у всех вызвал восторг тот факт, что при этом длинна массива нулевая. Т.е.:</p>
<pre><strong>const</strong> a = [];<br>a[<strong>NaN</strong>] = 123;</pre>
<pre>console.log(a) // [ NaN: 123 ]<br>a.length == 0  // true<br>a[<strong>NaN</strong>] === 123 // true</pre>
<p>И показалось будто бы нашелся новый баг/фича. Но если присмотреться внимательнее, то здесь нет магии. Вообще нет. И все работает согласно правилам.</p>
<h4>Разбираемся</h4>
<p>Начнем по порядку. Я ранее писал несколько постов на тему приведения типов, так что если хочется разобраться по подробнее, то лучше их перечитать, а я сразу буду говорить уже результаты.</p>
<p>Массив — это объект. И ему свойственны все атрибуты объекта в JS. По сути сам массив можно было бы описать как объект со свойством length и вспомогательными методами:</p>
<pre><strong>const</strong> a = { 0: 'a', 1: 'b', length: 2 };<br><strong>for</strong> (<strong>let</strong> i=0; i&lt;a.length; i++) console.log(a[i]);</pre>
<p>Так как NaN — это не число, то оно не может быть использовано как индекс массива (при том что тип NaN это number (парадокс, да)). А следовательно идет попытка создать новое свойство объекта. В JS мы можем добавить к любому объекту любое свойство в любое время (есть и исключения, да). Так как константа NaN как тип не может быть использована как свойство объекта, то происходит преобразование, а именно, вызывается toString():</p>
<pre><strong>NaN</strong>.toString() === 'NaN'<br>// поэтому<br>a = [];<br>a[<strong>NaN</strong>] = 123;<br>a['NaN'] === a[<strong>NaN</strong>]</pre>
<p>Тут нет никакой магии. Смотрим на вывод console.log и видим:</p>

<p>И выходит что мы видим что NaN это свойство объекта. Т.е. запись <code>a[NaN]</code> эквивалентна записи <code>a.NaN</code> и ничем не отличается от любой другой записи:</p>
<pre><strong>const</strong> a = [];<br>a['lol'] = 123;<br>a.length = 0;<br>a['lol'] === a.lol</pre>
<p>Почему NaN мы легко воспринимаем как число? По нескольким причинам. Одна из них это вывод типа:</p>
<pre>typeof NaN == 'number'</pre>
<p>Что уже как бы немного сбивает с толку. Еще одна причина по которой NaN некоторые принимают за число это его природа, так как хранится в <code>Number</code>:</p>
<pre><strong>const</strong> a = [];<br>a[<strong>NaN</strong>] = 123;</pre>
<pre><br>a[NaN] === a['NaN']<br>a[NaN] === a[Number.NaN]</pre>
<p>Но NaN — это Not a number, так что это не число.</p>
<h4>Вердикт</h4>
<p>По примеру — нет магии и удивление вызвало именно сочетание и мнимое ощущение что при скобочной нотации доступа к объекту создается ощущение что создается индекс массива. Но это не так. Массив это объект, а скобочная нотация позволяет обращаться к любому свойству и не отличается от точечной. Но когда речь идет о массиве это когнитивно сложно принять и легко запутаться.</p>
<p>Для себя выводы: не писать статьи вечером после работы, высыпаться, не публиковать посты сразу, дать им отлежаться, верить в себя и не поддаваться общей истерии, перепроверять мысли ?</p>


