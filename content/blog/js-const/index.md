---
title: "CONST в JS делает свою работу правильно!"
date: "2018-04-04T00:41:43.00Z"
description: "Разбираемся в сути и предназначении    На собеседовании фронтедеров частенько можно услышать вопрос, в чем разница между var, le"
---

<!--kg-card-begin: html--><h4>Разбираемся в сути и предназначении</h4>
<figure>
<p><img data-width="1024" data-height="400" src="https://cdn-images-1.medium.com/max/800/1*wE5HhRlFaI3rmCAn7TiGdw.png"><br />
</figure>
<p>На собеседовании фронтедеров частенько можно услышать вопрос, в чем разница между var, let и const. А далее вопрос могут раскрутить до вопроса: а покажите, как сделать неизменяемый объект. Вопрос вполне хороший и имеет право на жизнь.</p>
<p>Но в сети так же периодически можно услышать фразы и увидеть статьи о том, что <strong>const</strong> в JS не работает и что <em>не нужно</em> его использовать. И приводится пример, наподобие этого:</p>
<pre><strong>const</strong> obj = { foo: 123 }<br>obj.foo = 456; // все прекрасно меняется</pre>
<p>Ну вообще-то да, поле объекта меняется. <strong>И должно меняться</strong>. <strong>Не меняется ссылка на значение.</strong> В данном случае ссылка на объект. Поля объекта меняются и должны меняться иначе это было бы странно. Это не бага JS! Все работает правильно.</p>
<blockquote><p>Константа — способ адресации данных, изменение которых не предполагается или запрещается.</p></blockquote>
<h3>Для чего используется слово const в JS?</h3>
<h4><strong>Usecase 1# Для описания констант.</strong></h4>
<p>Значения констант должны быть примитивы. Если вы хотите зафиксировать некоторые величины, которые не должны меняться на протяжении программы — вы описываете их как константы.</p>
<p>Такими величинами могут быть числа и строки. Т.е. примитивы. Есть исключения, но о них чуть позже. В JS уже есть встроенные константы. Например число Пи(Math.PI). Хотите записать тау (2PI)? Запишите:</p>
<pre><strong>const</strong> PI  = Math.PI<br><strong>const</strong> TAU = PI * 2</pre>
<p>Эти значения будут константными и неизменными. Все работает как и положено. Хотите сохранить строковые величины? Пожалуйста. Нужно записать флаг, например завести константы DEBUG? Да пожалуйста. Все ваши константы будут работать как надо:</p>
<pre><strong>const</strong> VERSION = 'My Framework 1.0.5'<br><strong>const</strong> DEBUG = true</pre>
<p>В качестве константы нужно и правильно использовать примитивы. В некоторых языках программирования на уровне компилятора/интерпретатора не разрешено создавать константы из чего-то, кроме примитивов. Не должно быть констант объектов. Константы должны быть простыми типами — примитивами. Но есть исключения.</p>
<h3>Исключения для const</h3>
<h4><strong>Usecase #2. Для описания неизменяемых объектов Function</strong></h4>
<p>Вопрос на собеседовании: как отработает этот код?</p>
<pre><strong>function</strong> foo(){ return 42 }<br><strong>function</strong> foo(){ return 43 }</pre>
<pre>console.log( foo() );</pre>
<p>В JS можно переопределять уже созданные функции. Это значит что вашу ранее объявленную функцию можно не просто переопределить, ее вовсе можно “прибить”. И сделать это можно даже чисто случайно. Например правите вы такой вот файл и…</p>
<pre>edit SomeApp.js<br>Line | Code<br>-----+----------------------------------<br>1    | // Some JS file<br>     | ...<br>     |<br>128  | <strong>function</strong> foo(){ return 42 }<br>     |<br>     | ...<br>512  |<br>513  | <strong>var</strong> foo = 456;<br>514  |<br>     | ...<br>     |<br>1024 | foo() // error!!! foo = 456</pre>
<p>Наверняка кто-то из вас сталкивался с чем-то подобным. Этот пример утрирован, но он реален и имеет место быть в практике.</p>
<p><em>Кстати, почему так произошло — отдельная тема, связанная с всплытием переменных(hoisting). Про это поговорим в ближайшее время.</em></p>
<p>Что можно было сделать? Как вариант — использовать функциональные выражения:</p>
<pre><strong>const</strong> foo = <strong>function</strong>(){ <strong>return</strong> 42 }</pre>
<pre>// или</pre>
<pre><strong>const</strong> foo = () <strong>=&gt;</strong> 42</pre>
<p>Писать стрелочную функцию или нет — уже дело выбора и предназначения (нужно ли будет менять контекст или нужна привязка).</p>
<p>В данном случае foo — это объект. И у него есть даже поля, например вы можете получить имя функции:</p>
<pre>console.log( foo.name ) // "foo"</pre>
<p>Попробуйте изменить эту функцию или этот объект. Не получается?</p>
<h3>Как создать константный объект?</h3>
<p>Продолжаем наше импровизированное собеседование.</p>
<p>Если уж вам все-таки ну очень приспичило создать объект-константу, то тут мы все так же используем слово const но(!) добавляем такую штуку как Object.freeze().</p>
<blockquote><p>Метод Object.freeze() замораживает объект. Это значит, что он предотвращает добавление новых свойств к объекту, удаление старых свойств из объекта и изменение существующих свойств или значения их атрибутов перечисляемости, настраиваемости и записываемости. В сущности, объект становится неизменным. Метод возвращает замороженный объект.</p></blockquote>
<p>Видите, для заморозки объектов есть отдельный специальный механизм, который и делает наш любимый JS таким гибким. И если вы хотите создать констату-объект, то вы пишите следующий код:</p>
<pre><strong>const</strong> immutableObject = Object.<strong>freeze</strong>({<br>    foo: 123,<br>    bar: 'buz'<br>});</pre>
<pre>immutableObject = {} // error<br>immutableObject.foo = 456 // not alllowed<br>immutableObject.bebebe = 'abc' // not allowed</pre>
<p>Все прекрасно работает. Но создавать неизменяемый объект это прерогатива других механизмов, а не ключевого слова <strong>const</strong>.</p>
<p>Нужно запомнить, что слово</p>
<p><em>CONST — только для неизменяемой ссылки на ячейку памяти со значением.</em></p>
<p>И это правильная нормальная работа. И я не понимаю почему у некоторых бомбит и они пишут статьи на тему неработающего const.</p>
<p>И <strong>линтеры не должны</strong> вам ничего говорить и указывать, если вы указали константную ссылку на объект. Ссылка на объект и сам объект — это две разные сущности. Изменяемость объекта, как и передача его по ссылке — это вообще отдельная тема. А const делает свою работу прекрасно и правильно! И здорово что у нас есть такая гибкость, в отличие от других языков, и мы можем отдельно управлять иммутабельностью объектов и ссылок на объекты.</p>
<p>Если же продолжить собеседование, то можно уточнить про то, весь ли объект будет иммутабельным. А точнее будут ли дочерние элементы неизменяемыми?</p>
<pre><strong>const</strong> foo = Object.<strong>freeze</strong>({<br>  bar: 1,<br>  deep: {<br>   a: {<br>      b: {<br>        c: 1<br>      }<br>    }<br>  }<br>});</pre>
<pre>foo.bar = 456; // freeze<br>foo.deep.a.b.c = 2; // mutate</pre>
<pre>console.dir(foo);</pre>
<p>Да, Object.freeze() не делает глубокой заморозки. Но это все решаемо. Либо пишите все на ванильном JS либо используете специализированные библиотеки.</p>
<p>Так как это импровизированное собеседование, то давайте решим задачу на чистом JS:</p>
<pre><strong>const</strong> immutable = (obj) <strong>=&gt;</strong><br>(<br>  Object.<strong>freeze</strong>(obj),<br>  (<br>    (<strong>void</strong> 0 === obj) ? obj :<br>      (<br>        Object.<strong>getOwnPropertyNames</strong>(obj)<br>          .<strong>forEach</strong>(<br>            (prop) =&gt;<br>              (<br>                !Object.<strong>isFrozen</strong>(obj[prop]) &amp;&amp;<br>                (<br><strong>typeof</strong> obj[prop] == "object" ||<br><strong>typeof</strong> obj[prop] == "function"<br>                )<br>              )<br>              &amp;&amp; immutable(obj[prop])<br>          ),<br>          obj<br>      )<br>  )<br>);</pre>
<p>Вот так может быть реализована функция, порождающая неизменяемый объект. Да да да, много скобочек. Люблю, знаете ли, скобочки. Во мне умер lisp-программист на пару с perl программистом ?</p>
<p>Пример использования:</p>
<pre><strong>const</strong> foo = <strong>immutable</strong>({<br>  bar: 1,<br>  deep: {<br>   a: {<br>      b: {<br>        c: 1<br>      }<br>    }<br>  }<br>});</pre>
<pre>foo.bar = 456; // freeze<br>foo.deep.a.b.c = 2; // freeze</pre>
<p>Кстати, в ООП мире, функции, создающие новые объекты называются фабриками. Но это уже другая история и другая часть собеседования ?</p>

<!--kg-card-end: html-->

